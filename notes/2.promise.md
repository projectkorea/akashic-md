# Promise

## 1. What is `promise`?

-   `Promise` is a **built-in Javascript `object`** for **asynchronous**.
-   í”„ë¡œë¯¸ìŠ¤ ê°ì²´ëŠ” ì½œë°±ì§€ì˜¥ì„ í•´ê²°í•˜ê³ , ì—¬ëŸ¬ê°œì˜ ë¹„ë™ê¸° ì²˜ë¦¬ë¥¼ íš¨ê³¼ì ìœ¼ë¡œ ì²˜ë¦¬í•œë‹¤.
-   ì •í•´ì§„ ìž¥ì‹œê°„ì˜ ê¸°ëŠ¥ì„ ìˆ˜í–‰í•˜ë‹¤ê°€,
    -   ì •ìƒì ìœ¼ë¡œ ìž‘ë™í–ˆë‹¤ë©´, `resolve(data)`ë¥¼ í†µí•´ **data**ì„ ì „ë‹¬í•´ì£¼ê³ ,
    -   ì˜ˆìƒì¹˜ ëª»í•œ ê²°ê³¼ê°€ ë‚˜ì™”ë‹¤ë©´, `reject(error)`ë¥¼ í†µí•´ **error**ë¥¼ ì „ë‹¬í•œë‹¤.

#### í”„ë¡œë¯¸ìŠ¤ì˜ ê¸°ë³¸ êµ¬ì¡°

- í”„ë¡œë¯¸ìŠ¤ ê°ì²´ì˜ ì¶”ìƒ êµ¬ì¡°ëŠ” ë‹¤ìŒê³¼ ê°™ìœ¼ë©°, ì‹¤ì œë¡œ ì ‘ê·¼ í•  ìˆ˜ ìžˆëŠ” í”„ë¡œí¼í‹°ëŠ” ì•„ë‹ˆë‹¤.

```js
Promise.instance = {
  [[Prototype]] : {
    then
    catch,
    finally,
  },
  [[PromiseState]] : {
    pending,
    fulfilled,
    rejected
  },
  [[PromiseResult]] : {
    data
  }
}
```

#### í”„ë¡œë¯¸ìŠ¤ ê°ì²´ ìƒì„±

- `new Promise(callback)`
- `Promise`ê°ì²´ëŠ” `new` í‚¤ì›Œë“œì™€ `Promise` ìƒì„±ìžë¥¼ ì‚¬ìš©í•´ ë§Œë“ ë‹¤. 
- `Promise` ìƒì„±ìžëŠ” ë§¤ê°œë³€ìˆ˜ë¡œ **ì½œë°± í•¨ìˆ˜**ë¥¼ ë°›ëŠ”ë‹¤.
- ì½œë°±í•¨ìˆ˜ëŠ” `Promise`ê°ì²´ë¥¼ ë°˜í™˜í•˜ê¸°ë„ ì „ì— **ë°”ë¡œ ì‹¤í–‰**ëœë‹¤.
- ì½œë°±í•¨ìˆ˜ëŠ” `resolve` í•¨ìˆ˜ ì™€ `reject` í•¨ìˆ˜ë¥¼ ì¸ìžë¡œ ë°›ëŠ”ë‹¤.

```js
const promise = new Promise((resolve, reject) => {
// ...
// resolveë‚˜ reject ì¤‘ í•˜ë‚˜ë¥¼ í˜¸ì¶œí•˜ëŠ” ë¹„ë™ê¸° ìž‘ì—…ì„ ìˆ˜í–‰í•œë‹¤.
//   resolve(someValue)        // fulfilled
//   reject("failure reason")  // rejected

});
```

## 2. state

- `resolve`, `reject` í•¨ìˆ˜ë¥¼ í†µí•´ í”„ë¡œë¯¸ìŠ¤ ê°ì²´ì˜ ìƒíƒœë¥¼ ë°”ê¿€ ìˆ˜ ìžˆë‹¤.
   1. pending: ê¸°ëŠ¥ ìˆ˜í–‰ì¤‘ì¸ ìƒíƒœ
   2. fulfilled: ì„±ê³µ
   3. rejected: ì‹¤íŒ¨

#### 1) fulfilled

```js
const promise = new Promise(function(resolve, reject){
    resolve('value')
})
promise.then(value=>console.log(value))
```

- ì½œë°± í•¨ìˆ˜ì˜ ì¸ìž `resolve(value)` ë¥¼ ì‹¤í–‰í•˜ë©´ **`value`ê°’ì„ ì§€ë‹Œ Fulfilled(ì´í–‰) ìƒíƒœì˜ Promise ê°ì²´ë¥¼ ë¦¬í„´í•œë‹¤**.
- ì´í–‰ ìƒíƒœê°€ ë˜ë©´ `.then(value)`ì„ ì´ìš©í•˜ì—¬ ê²°ê³¼ ê°’ì„ ë°›ì„ ìˆ˜ ìžˆë‹¤.

#### 2) rejected

```js
new Promise(function(resolve, reject){
    reject(new Error('Error occured!'))
})
promise.catch(err=>console.log(err))
```

- ì½œë°± í•¨ìˆ˜ì˜ ì¸ìž `reject()` ë¥¼ ì‹¤í–‰í•˜ë©´ **Rejected(error)) ìƒíƒœì˜ Promise ê°ì²´ë¥¼ ë¦¬í„´í•œë‹¤**
- ì‹¤íŒ¨ ìƒíƒœê°€ ë˜ë©´, ì‹¤íŒ¨ ì²˜ë¦¬ ê²°ê³¼ ê°’ì„ í›„ì† ì²˜ë¦¬ ë©”ì†Œë“œ `catch()` ë¡œ ë°›ì•„ ì²˜ë¦¬í•  ìˆ˜ ìžˆë‹¤.

## 3. producer / consumer

  1) producer: `promise` ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì§€ì¹­í•œë‹¤.
  2) consumer
     - `.then()`, `.catch()`, `.finally()`
     - `Promise ê°ì²´`ì˜ ìƒíƒœì— ë”°ë¼ ì²˜ë¦¬ í•  í›„ì† ì²˜ë¦¬ ë©”ì†Œë“œë¥¼ ì¼ì»«ëŠ”ë‹¤.

#### 1) Producer ì •ì˜

```js
const promise = new Promise((resolve, reject) => {
    
    //doing some heavy work(network, read files)
    console.log('...');
    setTimeout(() => {
        resolve('junha');
    }, 2000);

    reject(new Error('no network'));
});
```

ì»¨ì†” ê²°ê³¼  

```
// 1. ...
```

#### 2) Consumer ì •ì˜

```js
promise
    .then((value) => {
        console.log(value); // 4
    })
    .catch((error) => {
        console.log(error); // 2
    })
    .finally(() => {
        console.log('finally'); // 3
    });
```

ì»¨ì†” ê²°ê³¼  
```
// 2. Error: no network
// 3. finally
```
- ë¹„ë™ê¸° í•¨ìˆ˜ `setTimeout`ê°€ ì‹¤í–‰ë˜ê¸° ì „ì— `reject()`ê°€ ì‹¤í–‰ë˜ì–´ **rejectedëœ promiseê°€ ë°˜í™˜ëœë‹¤.**

#### (1) `.then(onFulfilled, onRejected);`
- `then` ë©”ì†Œë“œëŠ” ë‘ ê°œì˜ **ì½œë°± í•¨ìˆ˜ë¥¼ ì¸ìžë¡œ** ë°›ëŠ”ë‹¤. 
- ì²« ë²ˆì§¸ ì½œë°± í•¨ìˆ˜ëŠ” Fulfilled, resolve í•¨ìˆ˜ê°€ í˜¸ì¶œëœ ìƒíƒœì‹œ, í˜¸ì¶œë˜ê³ 
- ë‘ ë²ˆì§¸ í•¨ìˆ˜ëŠ” Reject, reject í•¨ìˆ˜ê°€ í˜¸ì¶œëœ ìƒíƒœì‹œ í˜¸ì¶œëœë‹¤.
- then ë©”ì†Œë“œëŠ” **Promiseë¥¼ ë°˜í™˜**í•œë‹¤.

#### (2) `.catch(onRejected);`
- ì˜ˆì™¸(ë¹„ë™ê¸° ì²˜ë¦¬ ë˜ëŠ” then ë©”ì†Œë“œì—ì„œ ë°œìƒí•œ ì—ëŸ¬)ê°€ ë°œìƒí•˜ë©´ í˜¸ì¶œëœë‹¤.
- catch ë©”ì†Œë“œëŠ” **Promiseë¥¼ ë°˜í™˜**í•œë‹¤.

#### (3) `.finally(onFinally);`
- Promiseê°€ ì²˜ë¦¬ë˜ë©´ ìƒíƒœì— ìƒê´€ì—†ì´ ì§€ì •ëœ ì½œë°± í•¨ìˆ˜ê°€ ì‹¤í–‰ëœë‹¤.
- `finally`ì—ì„œëŠ” ì–´ë– í•œ ì¸ìžë„ ë°›ì„ ìˆ˜ ì—†ë‹¤


## 3. Promise Chaining

- `.then()`ê³¼ `.catch()`ëŠ” `Promise`ë¥¼ ë¦¬í„´í•œë‹¤.
-  ë”°ë¼ì„œ `.then()`ë˜ëŠ” `catch()`ë¡œ ë‹¤ì‹œ ì²´ì´ë‹ í•  ìˆ˜ ìžˆë‹¤.
-  `.catch()`ì— `.then()`ì´ ë¶™ì–´ìžˆë‹¤ë©´, `catch`ì—ì„œ ë¦¬í„´í•œ ê°’ì€ `then`ìœ¼ë¡œ ì „ë‹¬ëœë‹¤.

**ì˜ˆì‹œ1) ì²´ì´ë‹ ì˜ˆì‹œ ì½”ë“œ**

```js
const fetchNumber = new Promise((resolve, reject) => {
    setTimeout(() => resolve(1), 1000);
});

fetchNumber
    .then((num) => num * 2)
    .then((num) => num * 3)
    .then((num) => {
        return new Promise((resolve, reject) => {
            setTimeout(() => resolve(num - 1), 1000);
        });
    });
    .then(num => console.log(num))
```

**ì˜ˆì‹œ2) ì›¹ ì„œë¹„ìŠ¤ ì¸ì¦ ì½”ë“œ**

```js
var userInfo = {
  id: 'test@abc.com',
  pw: '****'
};

function parseValue() {
  return new Promise({
    // ...
  });
}
function auth() {
  return new Promise({
    // ...
  });
}
function display() {
  return new Promise({
    // ...
  });
}
```
```js
getData(userInfo)
  .then(parseValue)
  .then(auth)
  .then(diaplay);
```
- `.then()`ì´ Promise ê°ì²´ë¥¼ ë°˜í™˜í•˜ê¸° ë•Œë¬¸ì— ì²´ì´ë‹ì´ ê°€ëŠ¥í•˜ë‹¤.


## 4. Error Handling

#### 1) `then()` ì˜ ë‘ë²ˆì§¸ ì¸ìžë¥¼ í™œìš©í•˜ëŠ” ë°©ë²•

```js
getData()
    .then(onFulfilled, onRejected);
```

#### 2) `catch()`ë¥¼ ì´ìš©í•˜ëŠ” ë°©ë²•

```js
getData()
    .then()
    .catch();
```

```js
getData().catch(function (err) {
  console.log(err);
});

getData().then(undefined, function (err) {
  console.log(err);
});
```
- `catch()`ëŠ” `then(undefined, onRejexted)`ë¥¼ í˜¸ì¶œí•œë‹¤.

#### 3) `.catch()` ì‚¬ìš©ì„ ê¶Œìž¥í•œë‹¤.

**ì˜ˆì‹œ) `then()`ì˜ ì²«ë²ˆì§¸ ì½œë°± í•¨ìˆ˜ ë‚´ë¶€ì—ì„œ ì˜¤ë¥˜ê°€ ë‚˜ëŠ” ê²½ìš°**

```js
function getData() {
  return new Promise(function (resolve, reject) {
    resolve("hi");
  });
}
```

```js
getData().then(
  function (result) {
    console.log(result);
    throw new Error("Error in then()");
    // Uncaught (in promise) Error: Error in then()
  },
  function (err) {
    console.log("then error : ", err);
    // this can't caught "Error in then()" Error
  }
);
```
- `then()` ì˜ ì²« ë²ˆì§¸ ì½œë°± í•¨ìˆ˜ ë‚´ë¶€ì—ì„œ ì˜¤ë¥˜ê°€ ë‚˜ëŠ” ê²½ìš° ìž¡ì•„ë‚´ì§€ ëª»í•œë‹¤.

```js
getData()
  .then(function (result) {
    console.log(result); // hi
    throw new Error("Error in then()");
  })
  .catch(function (err) {
    console.log("then error : ", err);
    // then error :  Error: Error in then()
  });
```

- `.catch()` ë©”ì†Œë“œë¥¼ ëª¨ë“  `.then()` ë©”ì†Œë“œë¥¼ í˜¸ì¶œí•œ ì´í›„ì— í˜¸ì¶œí•˜ë©´, ë¹„ë™ê¸° ì²˜ë¦¬ì—ì„œ ë°œìƒí•œ ì—ëŸ¬(reject í•¨ìˆ˜ê°€ í˜¸ì¶œëœ ìƒíƒœ)ë¿ë§Œ ì•„ë‹ˆë¼ then ë©”ì†Œë“œ ì•ˆì—ì„œ ë°œìƒí•œ ì—ëŸ¬ê¹Œì§€ ëª¨ë‘ ìºì¹˜í•  ìˆ˜ ìžˆë‹¤.
- ë”°ë¼ì„œ ê°€ë…ì„±ë„ ì¢‹ê³  ë” ë§Žì€ ì˜ˆì™¸ ì²˜ë¦¬ ìƒí™©ì„ ìœ„í•´ `catch()` ë¡œ ì—ëŸ¬ ì²˜ë¦¬ë¥¼ í•´ì£¼ëŠ” ê²ƒì´ ì¢‹ë‹¤.

#### 4) ìž¬ë¯¸ìžˆëŠ” ì˜ˆì‹œ

```js
const getHen = () => {
    new Promise((resolve, reject) => {
        setTimeout(() => resolve('ðŸ”'), 1000);
    });
};

const getEgg = (hen) =>
    new Promise((resolve, reject) => {
        setTimeout(() => resolve(`${hen} => 'ðŸ¥š'`), 1000);
    });

const getFry = (egg) =>
    new Promise((resolve, reject) => {
        setTimeout(() => resolve(`${egg} => 'ðŸ¥¯'`), 1000);
    });

getHen()
    .then((hen) => getEgg(hen))
    .catch((error) => {
        return `${egg} => 'ðŸ•'`;
    })
    .then((egg) => getFry(egg))
    .then((meal) => console.log(meal));
```

```js
.then((hen) => getEgg(hen))
.then(getEgg)
// ì•„ê·œë¨¼íŠ¸ê°€ ë™ì¼í•  ê²½ìš° ìƒëžµì´ ê°€ëŠ¥í•˜ë‹¤.
```

## 5. Promiseì˜ ë‹¤ì–‘í•œ ë©”ì„œë“œ

### 1) `Promise.all(iterable) :array` 

-   promiseê°€ ë‹´ê¸´ iterable ê°ì²´ë¥¼ ì „ë‹¬í•˜ê²Œ ë˜ë©´, **ëª¨ë“  promiseë“¤ì´ ë³‘ë ¬ì ìœ¼ë¡œ ì™„ë£Œëœ í›„ì—**, **Promiseë¥¼ ë°˜í™˜**í•œë‹¤.
-   ì£¼ì–´ì§„ **í”„ë¡œë¯¸ìŠ¤ ì¤‘ í•˜ë‚˜ê°€ ê±°ë¶€í•˜ëŠ” ê²½ìš°**, ì²« ë²ˆì§¸ë¡œ ê±°ì ˆí•œ í”„ë¡œë¯¸ìŠ¤ì˜ ì´ìœ ë¥¼ ì‚¬ìš©í•´ **ìžì‹ ë„ ê±°ë¶€**í•œë‹¤.

```js
const promise1 = Promise.resolve(3);
const promise2 = 42;
const promise3 = new Promise((resolve, reject) => {
  setTimeout(resolve, 100, 'foo');
});

Promise.all([promise1, promise2, promise3]).then((values) => {
  console.log(values);
});
// expected output: Array [3, 42, "foo"]
```

```js
function pickAllFruits() {
    return Promise.all([getApple(), getBanana()]).then((fruits) =>
        fruits.join('+')
    );
}
pickAllFruits().then(console.log);
```

### 2) `Promise.race()`
-   `Promise.race([func1(), func2()])`
-   ê°€ìž¥ ë¨¼ì € `settled`ëœ `promise`ë¥¼ ë°˜í™˜í•œë‹¤.

```js
function pickOnlyOne() {
    return Promise.race([getApple(), getBanana()]);
}
pickOnlyOne().then(console.log);
```

### 3) `Promise.any()`

-   ê°€ìž¥ ë¨¼ì € `fulfilled`ëœ `promise` ë¥¼ ë°˜í™˜í•œë‹¤.
-   ëª¨ë“  `promise`ê°€ `rejected`ë˜ë©´, `AggregateError`ë¥¼ ê°€ì§„ `promiseë¥¼` ë°˜í•œí•œë‹¤.

```js
const promise1 = Promise.reject(0);
const promise2 = new Promise((resolve) => setTimeout(resolve, 100, 'quick'));
const promise3 = new Promise((resolve) => setTimeout(resolve, 500, 'slow'));

const promises = [promise1, promise2, promise3];

Promise.any(promises).then((value) => console.log(value));

// expected output: "quick"
```